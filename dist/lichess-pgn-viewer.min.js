var LichessPgnViewer=function(){"use strict";class e{unwrap(e,t){const n=this._chain((t=>r.ok(e?e(t):t)),(e=>t?r.ok(t(e)):r.err(e)));if(n.isErr)throw n.error;return n.value}map(e,t){return this._chain((t=>r.ok(e(t))),(e=>r.err(t?t(e):e)))}chain(e,t){return this._chain(e,t||(e=>r.err(e)))}}class t extends e{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,t){return e(this.value)}}class n extends e{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,t){return t(this.error)}}var r;!function(e){e.ok=function(e){return new t(e)},e.err=function(e){return new n(e||new Error)},e.all=function(t){if(Array.isArray(t)){const n=[];for(let e=0;e<t.length;e++){const r=t[e];if(r.isErr)return r;n.push(r.value)}return e.ok(n)}const n={},r=Object.keys(t);for(let e=0;e<r.length;e++){const s=t[r[e]];if(s.isErr)return s;n[r[e]]=s.value}return e.ok(n)}}(r||(r={}));const s=["a","b","c","d","e","f","g","h"],i=["1","2","3","4","5","6","7","8"],o=["white","black"],a=["pawn","knight","bishop","rook","queen","king"],c=["a","h"],h=e=>"role"in e,u=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),l=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,d=e=>l(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class p{constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new p(0,1<<e-32):new p(1<<e,0)}static fromRank(e){return new p(255,0).shl64(8*e)}static fromFile(e){return new p(16843009<<e,16843009<<e)}static empty(){return new p(0,0)}static full(){return new p(4294967295,4294967295)}static corners(){return new p(129,2164260864)}static center(){return new p(402653184,24)}static backranks(){return new p(255,4278190080)}static backrank(e){return"white"===e?new p(255,0):new p(0,4278190080)}static lightSquares(){return new p(1437226410,1437226410)}static darkSquares(){return new p(2857740885,2857740885)}complement(){return new p(~this.lo,~this.hi)}xor(e){return new p(this.lo^e.lo,this.hi^e.hi)}union(e){return new p(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new p(this.lo&e.lo,this.hi&e.hi)}diff(e){return new p(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?p.empty():e>=32?new p(this.hi>>>e-32,0):e>0?new p(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?p.empty():e>=32?new p(0,this.lo<<e-32):e>0?new p(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new p(l(this.hi),l(this.lo))}rbit64(){return new p(d(this.hi),d(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new p(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return u(this.lo)+u(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new p(this.lo,this.hi|1<<e-32):new p(this.lo|1<<e,this.hi)}without(e){return e>=32?new p(this.lo,this.hi&~(1<<e-32)):new p(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new p(this.lo,this.hi^1<<e-32):new p(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new p(this.lo&this.lo-1,this.hi):new p(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}class f{constructor(){}static default(){const e=new f;return e.reset(),e}reset(){this.occupied=new p(65535,4294901760),this.promoted=p.empty(),this.white=new p(65535,0),this.black=new p(0,4294901760),this.pawn=new p(65280,16711680),this.knight=new p(66,1107296256),this.bishop=new p(36,603979776),this.rook=new p(129,2164260864),this.queen=new p(8,134217728),this.king=new p(16,268435456)}static empty(){const e=new f;return e.clear(),e}clear(){this.occupied=p.empty(),this.promoted=p.empty();for(const e of o)this[e]=p.empty();for(const e of a)this[e]=p.empty()}clone(){const e=new f;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of o)e[t]=this[t];for(const t of a)e[t]=this[t];return e}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of a)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class m{constructor(){}static empty(){const e=new m;for(const t of a)e[t]=0;return e}static fromBoard(e,t){const n=new m;for(const r of a)n[r]=e.pieces(t,r).size();return n}clone(){const e=new m;for(const t of a)e[t]=this[t];return e}equals(e){return a.every((t=>this[t]===e[t]))}add(e){const t=new m;for(const n of a)t[n]=this[n]+e[n];return t}nonEmpty(){return a.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class g{constructor(e,t){this.white=e,this.black=t}static empty(){return new g(m.empty(),m.empty())}static fromBoard(e){return new g(m.fromBoard(e,"white"),m.fromBoard(e,"black"))}clone(){return new g(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new g(this.white.add(e.white),this.black.add(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class k{constructor(e,t){this.white=e,this.black=t}static default(){return new k(3,3)}clone(){return new k(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}const v=e=>void 0!==e,b=e=>"white"===e?"black":"white",w=e=>e>>3,y=e=>7&e,C=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function S(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function E(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}const x=e=>s[y(e)]+i[w(e)],q=e=>h(e)?`${C(e.role).toUpperCase()}@${x(e.to)}`:x(e.from)+x(e.to)+(e.promotion?C(e.promotion):""),M=(e,t)=>"white"===e?"a"===t?2:6:"a"===t?58:62;var O;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(O||(O={}));class A extends Error{}const R=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,P=e=>{const t=S(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},N=e=>{const t=f.empty();let n=7,s=0;for(let i=0;i<e.length;i++){const o=e[i];if("/"===o&&8===s)s=0,n--;else{const a=parseInt(o,10);if(a>0)s+=a;else{if(s>=8||n<0)return r.err(new A(O.Board));const a=s+8*n,c=P(o);if(!c)return r.err(new A(O.Board));"~"===e[i+1]&&(c.promoted=!0,i++),t.set(a,c),s++}}}return 0!==n||8!==s?r.err(new A(O.Board)):r.ok(t)},_=e=>{if(e.length>64)return r.err(new A(O.Pockets));const t=g.empty();for(const n of e){const e=P(n);if(!e)return r.err(new A(O.Pockets));t[e.color][e.role]++}return r.ok(t)},B=e=>{const t=e.split("+");if(3===t.length&&""===t[0]){const e=R(t[1]),n=R(t[2]);return!v(e)||e>3||!v(n)||n>3?r.err(new A(O.RemainingChecks)):r.ok(new k(3-e,3-n))}if(2===t.length){const e=R(t[0]),n=R(t[1]);return!v(e)||e>3||!v(n)||n>3?r.err(new A(O.RemainingChecks)):r.ok(new k(e,n))}return r.err(new A(O.RemainingChecks))},T=e=>{const t=e.split(/[\s_]+/),n=t.shift();let s,i,a=r.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return r.err(new A(O.Fen));s=N(n.slice(0,e)),a=_(n.slice(e+1,-1))}else{const e=((e,t,n)=>{let r=e.indexOf(t);for(;n-- >0&&-1!==r;)r=e.indexOf(t,r+t.length);return r})(n,"/",7);-1===e?s=N(n):(s=N(n.slice(0,e)),a=_(n.slice(e+1)))}const c=t.shift();if(v(c)&&"w"!==c){if("b"!==c)return r.err(new A(O.Turn));i="black"}else i="white";return s.chain((e=>{const n=t.shift(),s=v(n)?((e,t)=>{let n=p.empty();if("-"===t)return r.ok(n);for(const s of t){const t=s.toLowerCase(),i=s===t?"black":"white",o=p.backrank(i).intersect(e[i]);let a;if("q"===t)a=o;else if("k"===t)a=o.reversed();else{if(!("a"<=t&&t<="h"))return r.err(new A(O.Castling));a=p.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(o)}for(const t of a){if(e.king.has(t))break;if(e.rook.has(t)){n=n.with(t);break}}}return o.some((e=>p.backrank(e).intersect(n).size()>2))?r.err(new A(O.Castling)):r.ok(n)})(e,n):r.ok(p.empty()),c=t.shift();let h;if(v(c)&&"-"!==c&&(h=E(c),!v(h)))return r.err(new A(O.EpSquare));let u,l=t.shift();v(l)&&l.includes("+")&&(u=B(l),l=t.shift());const d=v(l)?R(l):0;if(!v(d))return r.err(new A(O.Halfmoves));const f=t.shift(),m=v(f)?R(f):1;if(!v(m))return r.err(new A(O.Fullmoves));const g=t.shift();let k=r.ok(void 0);if(v(g)){if(v(u))return r.err(new A(O.RemainingChecks));k=B(g)}else v(u)&&(k=u);return t.length>0?r.err(new A(O.Fen)):a.chain((t=>s.chain((n=>k.map((r=>({board:e,pockets:t,turn:i,unmovedRooks:n,remainingChecks:r,epSquare:h,halfmoves:d,fullmoves:Math.max(1,m)})))))))}))},K=e=>{let t=C(e.role);return"white"===e.color&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},L=e=>{let t="",n=0;for(let r=7;r>=0;r--)for(let s=0;s<8;s++){const i=s+8*r,o=e.get(i);o?(n>0&&(t+=n,n=0),t+=K(o)):n++,7===s&&(n>0&&(t+=n,n=0),0!==r&&(t+="/"))}return t},z=e=>a.map((t=>C(t).repeat(e[t]))).join(""),D=(e,t)=>{let n="";for(const r of o){const i=p.backrank(r),o=e.kingOf(r);if(!v(o)||!i.has(o))continue;const a=e.pieces(r,"rook").intersect(i);for(const e of t.intersect(a).reversed())if(e===a.first()&&e<o)n+="white"===r?"Q":"q";else if(e===a.last()&&o<e)n+="white"===r?"K":"k";else{const t=s[y(e)];n+="white"===r?t.toUpperCase():t}}return n||"-"},I=(e,t)=>{return[L(e.board)+(e.pockets?`[${r=e.pockets,z(r.white).toUpperCase()+z(r.black)}]`:""),e.turn[0],D(e.board,e.unmovedRooks),v(e.epSquare)?x(e.epSquare):"-",...e.remainingChecks?[(n=e.remainingChecks,`${n.white}+${n.black}`)]:[],...(null==t?void 0:t.epd)?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var n,r},F=(e,t)=>{let n=p.empty();for(const r of t){const t=e+r;0<=t&&t<64&&Math.abs(y(e)-y(t))<=2&&(n=n.with(t))}return n},$=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},U=$((e=>F(e,[-9,-8,-7,-1,1,7,8,9]))),V=$((e=>F(e,[-17,-15,-10,-6,6,10,15,17]))),H={white:$((e=>F(e,[7,9]))),black:$((e=>F(e,[-7,-9])))},W=e=>U[e],j=e=>V[e],G=(e,t)=>H[e][t],Q=$((e=>p.fromFile(y(e)).without(e))),Y=$((e=>p.fromRank(w(e)).without(e))),Z=$((e=>{const t=new p(134480385,2151686160),n=8*(w(e)-y(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),X=$((e=>{const t=new p(270549120,16909320),n=8*(w(e)+y(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),J=(e,t,n)=>{let r=n.intersect(t),s=r.bswap64();return r=r.minus64(e),s=s.minus64(e.bswap64()),r.xor(s.bswap64()).intersect(t)},ee=(e,t)=>{const n=p.fromSquare(e);return J(n,Z[e],t).xor(J(n,X[e],t))},te=(e,t)=>((e,t)=>J(p.fromSquare(e),Q[e],t))(e,t).xor(((e,t)=>{const n=Y[e];let r=t.intersect(n),s=r.rbit64();return r=r.minus64(p.fromSquare(e)),s=s.minus64(p.fromSquare(63-e)),r.xor(s.rbit64()).intersect(n)})(e,t)),ne=(e,t)=>ee(e,t).xor(te(e,t)),re=(e,t,n)=>{switch(e.role){case"pawn":return G(e.color,t);case"knight":return j(t);case"bishop":return ee(t,n);case"rook":return te(t,n);case"queen":return ne(t,n);case"king":return W(t)}},se=(e,t)=>{const n=p.fromSquare(t);return Y[e].intersects(n)?Y[e].with(e):X[e].intersects(n)?X[e].with(e):Z[e].intersects(n)?Z[e].with(e):Q[e].intersects(n)?Q[e].with(e):p.empty()},ie=(e,t)=>se(e,t).intersect(p.full().shl64(e).xor(p.full().shl64(t))).withoutFirst();var oe;!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(oe||(oe={}));class ae extends Error{}const ce=(e,t)=>"white"===e?"a"===t?3:5:"a"===t?59:61;class he{constructor(){}static default(){const e=new he;return e.unmovedRooks=p.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new p(14,0),h:new p(96,0)},black:{a:new p(0,234881024),h:new p(0,1610612736)}},e}static empty(){const e=new he;return e.unmovedRooks=p.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:p.empty(),h:p.empty()},black:{a:p.empty(),h:p.empty()}},e}clone(){const e=new he;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,r){const s=M(e,t),i=ce(e,t);this.unmovedRooks=this.unmovedRooks.with(r),this.rook[e][t]=r,this.path[e][t]=ie(r,i).with(i).union(ie(n,s).with(s)).without(n).without(r)}static fromSetup(e){const t=he.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const r of o){const s=p.backrank(r),i=e.board.kingOf(r);if(!v(i)||!s.has(i))continue;const o=n.intersect(e.board[r]).intersect(s),a=o.first();v(a)&&a<i&&t.add(r,"a",i,a);const c=o.last();v(c)&&i<c&&t.add(r,"h",i,c)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of o)for(const n of c)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardColor(e){this.unmovedRooks=this.unmovedRooks.diff(p.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class ue{constructor(e){this.rules=e}reset(){this.board=f.default(),this.pockets=void 0,this.turn="white",this.castles=he.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=p.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=he.fromSetup(e),this.epSquare=de(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,t,n){return((e,t,n,r)=>n[t].intersect(te(e,r).intersect(n.rooksAndQueens()).union(ee(e,r).intersect(n.bishopsAndQueens())).union(j(e).intersect(n.knight)).union(W(e).intersect(n.king)).union(G(b(t),e).intersect(n.pawn))))(e,t,this.board,n)}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[b(t.color)][t.promoted?"pawn":t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!v(t))return{king:t,blockers:p.empty(),checkers:p.empty(),variantEnd:e,mustCapture:!1};const n=te(t,p.empty()).intersect(this.board.rooksAndQueens()).union(ee(t,p.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[b(this.turn)]);let r=p.empty();for(const e of n){const n=ie(t,e).intersect(this.board.occupied);n.moreThanOne()||(r=r.union(n))}return{king:t,blockers:r,checkers:this.kingAttackers(t,b(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(e){if(this.board.occupied.isEmpty())return r.err(new ae(oe.Empty));if(2!==this.board.king.size())return r.err(new ae(oe.Kings));if(!v(this.board.kingOf(this.turn)))return r.err(new ae(oe.Kings));const t=this.board.kingOf(b(this.turn));return v(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?r.err(new ae(oe.OppositeCheck)):p.backranks().intersects(this.board.pawn)?r.err(new ae(oe.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers():r.err(new ae(oe.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(v(e)){const t=this.kingAttackers(e,b(this.turn),this.board.occupied);if(t.nonEmpty())if(v(this.epSquare)){const n=8^this.epSquare,s=24^this.epSquare;if(t.moreThanOne()||t.first()!==n&&this.kingAttackers(e,b(this.turn),this.board.occupied.without(n).with(s)).nonEmpty())return r.err(new ae(oe.ImpossibleCheck))}else if(t.size()>2||2===t.size()&&se(t.first(),t.last()).has(e))return r.err(new ae(oe.ImpossibleCheck))}return r.ok(void 0)}dropDests(e){return p.empty()}dests(e,t){if((t=t||this.ctx()).variantEnd)return p.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return p.empty();let r,s;if("pawn"===n.role){r=G(this.turn,e).intersect(this.board[b(this.turn)]);const n="white"===this.turn?8:-8,i=e+n;if(0<=i&&i<64&&!this.board.occupied.has(i)){r=r.with(i);const t=i+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(r=r.with(t))}if(v(this.epSquare)&&fe(this,e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(s=p.fromSquare(this.epSquare))}}else r="bishop"===n.role?ee(e,this.board.occupied):"knight"===n.role?j(e):"rook"===n.role?te(e,this.board.occupied):"queen"===n.role?ne(e,this.board.occupied):W(e);if(r=r.diff(this.board[this.turn]),v(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of r)this.kingAttackers(e,b(this.turn),n).nonEmpty()&&(r=r.without(e));return r.union(me(this,"a",t)).union(me(this,"h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!v(e))return p.empty();r=r.intersect(ie(e,t.king).with(e))}t.blockers.has(e)&&(r=r.intersect(se(e,t.king)))}return s&&(r=r.union(s)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){if(this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[e].intersects(this.board.knight))return this.board[e].size()<=2&&this.board[b(e)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[e].intersects(this.board.bishop)){return(!this.board.bishop.intersects(p.darkSquares())||!this.board.bishop.intersects(p.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:pe(this),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return o.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(h(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&(("pawn"!==e.role||!p.backranks().has(e.to))&&this.dropDests(t).has(e.to));{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&p.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(ve(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return v(e)&&this.kingAttackers(e,b(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(e))}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const t=this.variantOutcome(e);return t||(e=e||this.ctx(),this.isCheckmate(e)?{winner:b(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}play(e){const t=this.turn,n=this.epSquare,r=ke(this,e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=b(t),h(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let i;if("pawn"===s.role){this.halfmoves=0,e.to===n&&(i=this.board.take(e.to+("white"===t?-8:8)));const r=e.from-e.to;16===Math.abs(r)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if("rook"===s.role)this.castles.discardRook(e.from);else if("king"===s.role){if(r){const e=this.castles.rook[t][r];if(v(e)){const n=this.board.take(e);this.board.set(M(t,r),s),n&&this.board.set(ce(t,r),n)}}this.castles.discardColor(t)}if(!r){const t=this.board.set(e.to,s)||i;t&&this.playCaptureAt(e.to,t)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[t]=Math.max(this.remainingChecks[t]-1,0))}}class le extends ue{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}}const de=(e,t)=>{if(!v(t))return;const n="white"===e.turn?5:2,r="white"===e.turn?8:-8;if(w(t)!==n)return;if(e.board.occupied.has(t+r))return;const s=t-r;return e.board.pawn.has(s)&&e.board[b(e.turn)].has(s)?t:void 0},pe=e=>{if(!v(e.epSquare))return;const t=e.ctx(),n=e.board.pieces(e.turn,"pawn").intersect(G(b(e.turn),e.epSquare));for(const r of n)if(e.dests(r,t).has(e.epSquare))return e.epSquare},fe=(e,t,n)=>{if(!v(e.epSquare))return!1;if(!G(e.turn,t).has(e.epSquare))return!1;if(!v(n.king))return!0;const r=e.epSquare+("white"===e.turn?-8:8),s=e.board.occupied.toggle(t).toggle(e.epSquare).toggle(r);return!e.kingAttackers(n.king,b(e.turn),s).intersects(s)},me=(e,t,n)=>{if(!v(n.king)||n.checkers.nonEmpty())return p.empty();const r=e.castles.rook[e.turn][t];if(!v(r))return p.empty();if(e.castles.path[e.turn][t].intersects(e.board.occupied))return p.empty();const s=M(e.turn,t),i=ie(n.king,s),o=e.board.occupied.without(n.king);for(const t of i)if(e.kingAttackers(t,b(e.turn),o).nonEmpty())return p.empty();const a=ce(e.turn,t),c=e.board.occupied.toggle(n.king).toggle(r).toggle(a);return e.kingAttackers(s,b(e.turn),c).nonEmpty()?p.empty():p.fromSquare(r)},ge=(e,t,n)=>{if(n.variantEnd)return p.empty();const r=e.board.get(t);if(!r||r.color!==e.turn)return p.empty();let s=re(r,t,e.board.occupied);if("pawn"===r.role){let n=e.board[b(e.turn)];v(e.epSquare)&&(n=n.with(e.epSquare)),s=s.intersect(n);const r="white"===e.turn?8:-8,i=t+r;if(0<=i&&i<64&&!e.board.occupied.has(i)){s=s.with(i);const n=i+r;("white"===e.turn?t<16:t>=48)&&!e.board.occupied.has(n)&&(s=s.with(n))}return s}return s=s.diff(e.board[e.turn]),t===n.king?s.union(me(e,"a",n)).union(me(e,"h",n)):s},ke=(e,t)=>{if(h(t))return;const n=t.to-t.from;return(2===Math.abs(n)||e.board[e.turn].has(t.to))&&e.board.king.has(t.from)?n>0?"h":"a":void 0},ve=(e,t)=>{const n=ke(e,t);if(!n)return t;const r=e.castles.rook[e.turn][n];return{from:t.from,to:v(r)?r:t.to}},be=(e,t)=>{const n=e.ctx(),r=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!r){let r;if("O-O"===t||"O-O+"===t||"O-O#"===t?r="h":"O-O-O"!==t&&"O-O-O+"!==t&&"O-O-O#"!==t||(r="a"),r){const t=e.castles.rook[e.turn][r];if(!v(n.king)||!v(t)||!e.dests(n.king,n).has(t))return;return{from:n.king,to:t}}const s=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!s)return;const i={role:s[1]?S(s[1]):"pawn",to:E(s[2])};return e.isLegal(i,n)?i:void 0}const s=r[1]?S(r[1]):"pawn",i=E(r[4]),o=r[5]?S(r[5]):void 0;if(!!o!==("pawn"===s&&p.backranks().has(i)))return;if("king"===o&&"antichess"!==e.rules)return;let a=e.board.pieces(e.turn,s);"pawn"!==s||r[2]?r[2]&&(a=a.intersect(p.fromFile(r[2].charCodeAt(0)-"a".charCodeAt(0)))):a=a.intersect(p.fromFile(y(i))),r[3]&&(a=a.intersect(p.fromRank(r[3].charCodeAt(0)-"1".charCodeAt(0))));const c="pawn"===s?p.fromFile(y(i)):p.empty();let h;a=a.intersect(c.union(re({color:b(e.turn),role:s},i,e.board.occupied)));for(const t of a)if(e.dests(t,n).has(i)){if(v(h))return;h=t}return v(h)?{from:h,to:i,promotion:o}:void 0};class we extends ue{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=g.empty()}setupUnchecked(e){super.setupUnchecked(e),this.board.promoted=e.board.promoted.intersect(e.board.occupied).diff(e.board.king).diff(e.board.pawn),this.pockets=e.pockets?e.pockets.clone():g.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return super.validate(e).chain((e=>{var t,n;return(null===(t=this.pockets)||void 0===t?void 0:t.count("king"))?r.err(new ae(oe.Kings)):((null===(n=this.pockets)||void 0===n?void 0:n.size())||0)+this.board.occupied.size()>64?r.err(new ae(oe.Variant)):r.ok(void 0)}))}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(e)}dropDests(e){var t,n;const r=this.board.occupied.complement().intersect((null===(t=this.pockets)||void 0===t?void 0:t[this.turn].hasNonPawns())?p.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?p.backranks().complement():p.empty());if(e=e||this.ctx(),v(e.king)&&e.checkers.nonEmpty()){const t=e.checkers.singleSquare();return v(t)?r.intersect(ie(t,e.king)):p.empty()}return r}}class ye extends ue{constructor(){super("atomic")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return r.err(new ae(oe.Empty));if(this.board.king.size()>2)return r.err(new ae(oe.Kings));const t=this.board.kingOf(b(this.turn));return v(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?r.err(new ae(oe.OppositeCheck)):p.backranks().intersects(this.board.pawn)?r.err(new ae(oe.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers():r.err(new ae(oe.Kings))}validateCheckers(){return v(this.epSquare)?r.ok(void 0):super.validateCheckers()}kingAttackers(e,t,n){const r=this.board.pieces(t,"king");return r.isEmpty()||W(e).intersects(r)?p.empty():super.kingAttackers(e,t,n)}playCaptureAt(e,t){super.playCaptureAt(e,t),this.board.take(e);for(const t of W(e).intersect(this.board.occupied).diff(this.board.pawn)){const e=this.board.take(t);"rook"===(null==e?void 0:e.role)&&this.castles.discardRook(t),"king"===(null==e?void 0:e.role)&&this.castles.discardColor(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(b(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[b(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(p.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(p.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(p.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(p.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(1===this.board.knight.union(this.board.bishop).union(this.board.rook).size()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(e,t){t=t||this.ctx();let n=p.empty();for(const r of ge(this,e,t)){const t=this.clone();t.play({from:e,to:r});const s=t.board.kingOf(this.turn);!v(s)||v(t.board.kingOf(t.turn))&&!t.kingAttackers(s,t.turn,t.board.occupied).isEmpty()||(n=n.with(r))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(const e of o)if(this.board.pieces(e,"king").isEmpty())return{winner:b(e)}}}class Ce extends ue{constructor(){super("antichess")}reset(){super.reset(),this.castles=he.empty()}setupUnchecked(e){super.setupUnchecked(e),this.castles=he.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return this.board.occupied.isEmpty()?r.err(new ae(oe.Empty)):p.backranks().intersects(this.board.pawn)?r.err(new ae(oe.PawnsOnBackrank)):r.ok(void 0)}kingAttackers(e,t,n){return p.empty()}ctx(){const e=super.ctx();if(v(this.epSquare)&&G(b(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return e.mustCapture=!0,e;const t=this.board[b(this.turn)];for(const n of this.board[this.turn])if(ge(this,n,e).intersects(t))return e.mustCapture=!0,e;return e}dests(e,t){t=t||this.ctx();const n=ge(this,e,t),r=this.board[b(this.turn)];return n.intersect(t.mustCapture?v(this.epSquare)&&"pawn"===this.board.getRole(e)?r.with(this.epSquare):r:p.full())}hasInsufficientMaterial(e){if(this.board.occupied.equals(this.board.bishop)){const t=this.board[e].intersects(p.lightSquares()),n=this.board[e].intersects(p.darkSquares()),r=this.board[b(e)].isDisjoint(p.lightSquares()),s=this.board[b(e)].isDisjoint(p.darkSquares());return t&&r||n&&s}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if((e=e||this.ctx()).variantEnd||this.isStalemate(e))return{winner:this.turn}}}class Se extends ue{constructor(){super("kingofthehill")}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(p.center())}variantOutcome(e){for(const e of o)if(this.board.pieces(e,"king").intersects(p.center()))return{winner:e}}}class Ee extends ue{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=k.default()}setupUnchecked(e){var t;super.setupUnchecked(e),this.remainingChecks=(null===(t=e.remainingChecks)||void 0===t?void 0:t.clone())||k.default()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks)for(const e of o)if(this.remainingChecks[e]<=0)return{winner:e}}}class xe extends ue{constructor(){super("racingkings")}reset(){this.board=(()=>{const e=f.empty();return e.occupied=new p(65535,0),e.promoted=p.empty(),e.white=new p(61680,0),e.black=new p(3855,0),e.pawn=p.empty(),e.knight=new p(6168,0),e.bishop=new p(9252,0),e.rook=new p(16962,0),e.queen=new p(129,0),e.king=new p(33024,0),e})(),this.pockets=void 0,this.turn="white",this.castles=he.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){super.setupUnchecked(e),this.castles=he.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){return this.isCheck()||this.board.pawn.nonEmpty()?r.err(new ae(oe.Variant)):super.validate(e)}dests(e,t){if(e===(t=t||this.ctx()).king)return super.dests(e,t);let n=p.empty();for(const r of super.dests(e,t)){const t={from:e,to:r},s=this.clone();s.play(t),s.isCheck()||(n=n.with(r))}return n}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=p.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(v(n)){const t=this.board.occupied.without(n);for(const r of W(n).intersect(e).diff(this.board.black))if(this.kingAttackers(r,"white",t).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;const t=p.fromRank(7),n=this.board.pieces("black","king").intersects(t),r=this.board.pieces("white","king").intersects(t);return n&&!r?{winner:"black"}:r&&!n?{winner:"white"}:{winner:void 0}}}class qe extends ue{constructor(){super("horde")}reset(){this.board=(()=>{const e=f.empty();return e.occupied=new p(4294967295,4294901862),e.promoted=p.empty(),e.white=new p(4294967295,102),e.black=new p(0,4294901760),e.pawn=new p(4294967295,16711782),e.knight=new p(0,1107296256),e.bishop=new p(0,603979776),e.rook=new p(0,2164260864),e.queen=new p(0,134217728),e.king=new p(0,268435456),e})(),this.pockets=void 0,this.turn="white",this.castles=he.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const e=new this;return e.reset(),e}static fromSetup(e,t){const n=new this;return n.setupUnchecked(e),n.validate(t).map((e=>n))}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return r.err(new ae(oe.Empty));if(1!==this.board.king.size())return r.err(new ae(oe.Kings));const t=this.board.kingOf(b(this.turn));if(v(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return r.err(new ae(oe.OppositeCheck));for(const e of o){const t=this.board.pieces(e,"king").isEmpty()?p.backrank(b(e)):p.backranks();if(this.board.pieces(e,"pawn").intersects(t))return r.err(new ae(oe.PawnsOnBackrank))}return(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}class Me{constructor(){this.children=[]}*mainline(){let e=this;for(;e.children.length;){const t=e.children[0];yield t.data,e=t}}}class Oe extends Me{constructor(e){super(),this.data=e}}const Ae=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Re=e=>/^\s*$/.test(e),Pe=e=>e.startsWith("%");class Ne extends Error{}class _e{constructor(e,t=Ae,n=1e6){this.emitGame=e,this.initHeaders=t,this.maxBudget=n,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game={headers:this.initHeaders(),moves:new Me},this.consecutiveEmptyLines=0,this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(e){if(this.budget-=e,this.budget<0)throw new Ne("ERR_PGN_BUDGET")}parse(e,t){if(!(this.budget<0))try{let n=0;for(;;){const t=e.indexOf("\n",n);if(-1===t)break;const r=t>n&&"\r"===e[t-1]?t-1:t;this.consumeBudget(t-n),this.lineBuf.push(e.slice(n,r)),n=t+1,this.handleLine()}this.consumeBudget(e.length-n),this.lineBuf.push(e.slice(n)),(null==t?void 0:t.stream)||(this.handleLine(),this.emit(void 0))}catch(e){this.emit(e)}}handleLine(){let e=!0,t=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:t.startsWith("\ufeff")&&(t=t.slice("\ufeff".length)),this.state=1;case 1:if(Re(t)||Pe(t))return;this.state=2;case 2:if(Pe(t))return;if(this.consecutiveEmptyLines<1&&Re(t))return void this.consecutiveEmptyLines++;if(this.found=!0,this.consecutiveEmptyLines=0,t.startsWith("[")){this.consumeBudget(200);const e=t.match(/^\[([A-Za-z0-9_]+)\s+"(.*)"\]\s*$/);return void(e&&this.game.headers.set(e[1],e[2].replace(/\\"/g,'"').replace(/\\\\/g,"\\")))}this.state=3;case 3:{if(e){if(Pe(t))return;if(Re(t))return this.emit(void 0)}const n=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let r;for(;r=n.exec(t);){const e=this.stack[this.stack.length-1];let s=r[0];if(";"===s)return;if(s.startsWith("$"))this.handleNag(parseInt(s.slice(1),10));else if("!"===s)this.handleNag(1);else if("?"===s)this.handleNag(2);else if("!!"===s)this.handleNag(3);else if("??"===s)this.handleNag(4);else if("!?"===s)this.handleNag(5);else if("?!"===s)this.handleNag(6);else if("1-0"===s||"0-1"===s||"1/2-1/2"===s||"*"===s)1===this.stack.length&&"*"!==s&&this.game.headers.set("Result",s);else if("("===s)this.consumeBudget(100),this.stack.push({parent:e.parent,root:!1});else if(")"===s)this.stack.length>1&&this.stack.pop();else{if("{"===s){const e=n.lastIndex,r=" "===t[e]?e+1:e;t=t.slice(r),this.state=4;continue e}this.consumeBudget(100),"Z0"===s||"0000"===s||"@@@@"===s?s="--":s.startsWith("0")&&(s=s.replace(/0/g,"O")),e.node&&(e.parent=e.node),e.node=new Oe({san:s,startingComments:e.startingComments}),e.startingComments=void 0,e.root=!1,e.parent.children.push(e.node)}}return}case 4:{const n=t.indexOf("}");if(-1===n)return void this.commentBuf.push(t);{const r=n>0&&" "===t[n-1]?n-1:n;this.commentBuf.push(t.slice(0,r)),this.handleComment(),t=t.slice(n),this.state=3,e=!1}}}}handleNag(e){var t;this.consumeBudget(50);const n=this.stack[this.stack.length-1];n.node&&((t=n.node.data).nags||(t.nags=[]),n.node.data.nags.push(e))}handleComment(){var e,t;this.consumeBudget(100);const n=this.stack[this.stack.length-1],r=this.commentBuf.join("\n");this.commentBuf=[],n.node?((e=n.node.data).comments||(e.comments=[]),n.node.data.comments.push(r)):n.root?((t=this.game).comments||(t.comments=[]),this.game.comments.push(r)):(n.startingComments||(n.startingComments=[]),n.startingComments.push(r))}emit(e){if(4===this.state&&this.handleComment(),e)return this.emitGame(this.game,e);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Be=(e,t)=>{const n=(e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}})(e.get("Variant"));if(!n)return r.err(new ae(oe.Variant));const s=e.get("FEN");return s?T(s).chain((e=>((e,t,n)=>{switch(e){case"chess":return le.fromSetup(t,n);case"antichess":return Ce.fromSetup(t,n);case"atomic":return ye.fromSetup(t,n);case"horde":return qe.fromSetup(t,n);case"racingkings":return xe.fromSetup(t,n);case"kingofthehill":return Se.fromSetup(t,n);case"3check":return Ee.fromSetup(t,n);case"crazyhouse":return we.fromSetup(t,n)}})(n,e,t))):r.ok((e=>{switch(e){case"chess":return le.default();case"antichess":return Ce.default();case"atomic":return ye.default();case"horde":return qe.default();case"racingkings":return xe.default();case"kingofthehill":return Se.default();case"3check":return Ee.default();case"crazyhouse":return we.default()}})(n))},Te=["white","black"],Ke=["a","b","c","d","e","f","g","h"],Le=["1","2","3","4","5","6","7","8"],ze=[...Le].reverse(),De=Array.prototype.concat(...Ke.map((e=>Le.map((t=>e+t))))),Ie=e=>De[8*e[0]+e[1]],Fe=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],$e=e=>{if(e)return"@"===e[1]?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},Ue=De.map(Fe);const Ve=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},He=e=>"white"===e?"black":"white",We=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},je=(e,t)=>e.role===t.role&&e.color===t.color,Ge=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],Qe=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Ye=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},Ze=(e,t)=>{e.style.visibility=t?"visible":"hidden"},Xe=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},Je=e=>2===e.buttons||2===e.button,et=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function tt(e,t,n){const r=Fe(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}class nt{constructor(e,t){this.opts=e,this.redraw=t,this.nodes=[],this.index=0,this.menu=!1,this.node=()=>this.nodes[this.index],this.backward=()=>{this.index=Math.max(0,this.index-1),this.setGround(),this.redraw()},this.forward=()=>{this.index=Math.min(this.nodes.length-1,this.index+1),this.setGround(),this.redraw()},this.toggleMenu=()=>{this.menu=!this.menu,this.redraw()},this.flip=()=>{this.orientation=b(this.orientation),this.menu=!1,this.redraw()},this.cgOpts=()=>({fen:this.node().fen,orientation:this.orientation,check:this.node().check,lastMove:$e(this.node().uci)}),this.analysisUrl=()=>`/analysis/${this.node().fen.replace(" ","_")}?color=${this.orientation}`,this.practiceUrl=()=>`${this.analysisUrl()}#practice`,this.setGround=()=>this.withGround((e=>e.set(this.cgOpts()))),this.withGround=e=>this.ground&&e(this.ground),this.orientation=e.orientation||"white",this.translate=e.translate||(e=>e),this.game=((e,t=Ae)=>{const n=[];return new _e((e=>n.push(e)),t,NaN).parse(e),n})(e.pgn)[0];const n=Be(this.game.headers).unwrap(),r=e=>({fen:I(e.toSetup()),check:e.isCheck()});this.nodes.push(r(n));for(const e of this.game.moves.mainline()){const t=be(n,e.san);if(!t)throw console.error(e,this.game.headers,I(n.toSetup())),`Can't parse ${e}`;n.play(t),this.nodes.push(Object.assign(Object.assign({},r(n)),{san:e.san,uci:q(t)}))}this.index=this.nodes.length-1}}function rt(e,t){return Math.abs(e-t)}const st=(e,t,n,r)=>{const s=rt(e,n),i=rt(t,r);return 1===s&&2===i||2===s&&1===i},it=(e,t,n,r)=>rt(e,n)===rt(t,r),ot=(e,t,n,r)=>e===n||t===r,at=(e,t,n,r)=>it(e,t,n,r)||ot(e,t,n,r);function ct(e,t,n){const r=e.get(t);if(!r)return[];const s=Fe(t),i=r.role,o="pawn"===i?(a=r.color,(e,t,n,r)=>rt(e,n)<2&&("white"===a?r===t+1||t<=1&&r===t+2&&e===n:r===t-1||t>=6&&r===t-2&&e===n)):"knight"===i?st:"bishop"===i?it:"rook"===i?ot:"queen"===i?at:function(e,t,n){return(r,s,i,o)=>rt(r,i)<2&&rt(s,o)<2||n&&s===o&&s===("white"===e?0:7)&&(4===r&&(2===i&&t.includes(0)||6===i&&t.includes(7))||t.includes(i))}(r.color,function(e,t){const n="white"===t?"1":"8",r=[];for(const[s,i]of e)s[1]===n&&i.color===t&&"rook"===i.role&&r.push(Fe(s)[0]);return r}(e,r.color),n);var a;return Ue.filter((e=>(s[0]!==e[0]||s[1]!==e[1])&&o(s[0],s[1],e[0],e[1]))).map(Ie)}function ht(e,...t){e&&setTimeout((()=>e(...t)),1)}function ut(e){e.premovable.current&&(e.premovable.current=void 0,ht(e.premovable.events.unset))}function lt(e){const t=e.predroppable;t.current&&(t.current=void 0,ht(t.events.unset))}function dt(e,t,n){const r=e.pieces.get(t),s=e.pieces.get(n);if(t===n||!r)return!1;const i=s&&s.color!==r.color?s:void 0;return n===e.selected&&bt(e),ht(e.events.move,t,n,i),function(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;const s=Fe(t),i=Fe(n);if(0!==s[1]&&7!==s[1]||s[1]!==i[1])return!1;4!==s[0]||e.pieces.has(n)||(6===i[0]?n=Ie([7,i[1]]):2===i[0]&&(n=Ie([0,i[1]])));const o=e.pieces.get(n);return!(!o||o.color!==r.color||"rook"!==o.role||(e.pieces.delete(t),e.pieces.delete(n),s[0]<i[0]?(e.pieces.set(Ie([6,i[1]]),r),e.pieces.set(Ie([5,i[1]]),o)):(e.pieces.set(Ie([2,i[1]]),r),e.pieces.set(Ie([3,i[1]]),o)),0))}(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,ht(e.events.change),i||!0}function pt(e,t,n,r){if(e.pieces.has(n)){if(!r)return!1;e.pieces.delete(n)}return ht(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,ht(e.events.change),e.movable.dests=void 0,e.turnColor=He(e.turnColor),!0}function ft(e,t,n){const r=dt(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=He(e.turnColor),e.animation.current=void 0),r}function mt(e,t,n){if(yt(e,t,n)){const r=ft(e,t,n);if(r){const s=e.hold.stop();bt(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:s};return!0!==r&&(i.captured=r),ht(e.movable.events.after,t,n,i),!0}}else if(function(e,t,n){return t!==n&&Ct(e,t)&&ct(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,r){lt(e),e.premovable.current=[t,n],ht(e.premovable.events.set,t,n,r)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),bt(e),!0;return bt(e),!1}function gt(e,t,n,r){const s=e.pieces.get(t);s&&(function(e,t,n){const r=e.pieces.get(t);return!(!r||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==r.color||e.turnColor!==r.color))}(e,t,n)||r)?(e.pieces.delete(t),pt(e,s,n,r),ht(e.movable.events.afterNewPiece,s.role,n,{premove:!1,predrop:!1})):s&&function(e,t,n){const r=e.pieces.get(t),s=e.pieces.get(n);return!!r&&(!s||s.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==r.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===r.color&&e.turnColor!==r.color}(e,t,n)?function(e,t,n){ut(e),e.predroppable.current={role:t,key:n},ht(e.predroppable.events.set,t,n)}(e,s.role,n):(ut(e),lt(e)),e.pieces.delete(t),bt(e)}function kt(e,t,n){if(ht(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return bt(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&mt(e,e.selected,t))return void(e.stats.dragged=!1)}(wt(e,t)||Ct(e,t))&&(vt(e,t),e.hold.start())}function vt(e,t){e.selected=t,Ct(e,t)?e.premovable.dests=ct(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function bt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function wt(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function yt(e,t,n){var r,s;return t!==n&&wt(e,t)&&(e.movable.free||!!(null===(s=null===(r=e.movable.dests)||void 0===r?void 0:r.get(t))||void 0===s?void 0:s.includes(n)))}function Ct(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function St(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let s=!1;if(yt(e,n,r)){const t=ft(e,n,r);if(t){const i={premove:!0};!0!==t&&(i.captured=t),ht(e.movable.events.after,n,r,i),s=!0}}return ut(e),s}function Et(e){ut(e),lt(e),bt(e)}function xt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Et(e)}function qt(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let s=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(s=7-s),r>=0&&r<8&&s>=0&&s<8?Ie([r,s]):void 0}function Mt(e){return"white"===e.orientation}const Ot="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",At={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Rt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Pt(e){"start"===e&&(e=Ot);const t=new Map;let n=7,r=0;for(const s of e)switch(s){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const e=t.get(Ie([r-1,n]));e&&(e.promoted=!0);break}default:{const e=s.charCodeAt(0);if(e<57)r+=e-48;else{const e=s.toLowerCase();t.set(Ie([r,n]),{role:At[e],color:s===e?"black":"white"}),++r}}}return t}function Nt(e,t){t.animation&&(Bt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function _t(e,t){var n,r;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(r=t.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),Bt(e,t),t.fen&&(e.pieces=Pt(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,r]of e.pieces)"king"===r.role&&r.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&vt(e,e.selected),Nt(e,t),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,r=e.movable.dests.get(n),s=e.pieces.get(n);if(!r||!s||"king"!==s.role)return;e.movable.dests.set(n,r.filter((e=>!(e==="a"+t&&r.includes("c"+t)||e==="h"+t&&r.includes("g"+t)))))}}function Bt(e,t){for(const n in t)Tt(e[n])&&Tt(t[n])?Bt(e[n],t[n]):e[n]=t[n]}function Tt(e){return"object"==typeof e}function Kt(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),r=e(t),s=function(e,t){const n=new Map,r=[],s=new Map,i=[],o=[],a=new Map;let c,h,u;for(const[t,n]of e)a.set(t,zt(t,n));for(const e of De)c=t.pieces.get(e),h=a.get(e),c?h?je(c,h.piece)||(i.push(h),o.push(zt(e,c))):o.push(zt(e,c)):h&&i.push(h);for(const e of o)h=Dt(e,i.filter((t=>je(e.piece,t.piece)))),h&&(u=[h.pos[0]-e.pos[0],h.pos[1]-e.pos[1]],n.set(e.key,u.concat(u)),r.push(h.key));for(const e of i)r.includes(e.key)||s.set(e.key,e.piece);return{anims:n,fadings:s}}(n,t);if(s.anims.size||s.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:s},e||It(t,performance.now())}else t.dom.redraw();return r}(e,t):Lt(e,t)}function Lt(e,t){const n=e(t);return t.dom.redraw(),n}function zt(e,t){return{key:e,pos:Fe(e),piece:t}}function Dt(e,t){return t.sort(((t,n)=>We(e.pos,t.pos)-We(e.pos,n.pos)))[0]}function It(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}(r);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>It(e,t)))}}const Ft=["green","red","blue","yellow"];function $t(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?bt(e):Et(e);const n=Xe(t),r=qt(n,Mt(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:jt(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Ut(e))}function Ut(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=qt(t.pos,Mt(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?function(e,t,n,r){const s=Fe(e),i=Ue.filter((e=>at(s[0],s[1],e[0],e[1])||st(s[0],s[1],e[0],e[1]))),o=i.map((e=>tt(Ie(e),n,r))).map((e=>We(t,e))),[,a]=o.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[o[0],0]);return Ie(i[a])}(t.orig,t.pos,Mt(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),Ut(e)}}))}function Vt(e,t){e.drawable.current&&(e.drawable.current.pos=Xe(t))}function Ht(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!n(e))));r&&r.brush===t.brush||e.shapes.push(t);Gt(e)}(e.drawable,t),Wt(e))}function Wt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function jt(e){var t;const n=(e.shiftKey||e.ctrlKey)&&Je(e),r=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Ft[(n?1:0)+(r?2:0)]}function Gt(e){e.onChange&&e.onChange(e.shapes)}function Qt(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=Xe(t),s=qt(r,Mt(e),n);if(!s)return;const i=e.pieces.get(s),o=e.selected;var a;o||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Gt(a.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||i||o||function(e,t){const n=Mt(e),r=e.dom.bounds(),s=Math.pow(r.width/8,2);for(const i of e.pieces.keys()){const e=tt(i,n,r);if(We(e,t)<=s)return!0}return!1}(e,r))&&t.preventDefault();const c=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&yt(e,e.selected,s)?Kt((e=>kt(e,s)),e):kt(e,s);const u=e.selected===s,l=tn(e,s);if(i&&l&&u&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,s)){e.draggable.current={orig:s,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:l,previouslySelected:o,originTarget:t.target,keyHasChanged:!1},l.cgDragging=!0,l.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,Qe(a,Ge(n)(Fe(s),Mt(e))),Ze(a,!0)),Yt(e)}else c&&ut(e),h&&lt(e);e.dom.redraw()}function Yt(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(r&&je(r,n.piece)){if(!n.started&&We(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();Qe(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==qt(n.pos,Mt(e),t))}}else Jt(e);Yt(e)}))}function Zt(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=Xe(t))}function Xt(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);ut(e),lt(e);const r=qt(Xe(t)||n.pos,Mt(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?gt(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,mt(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),ht(e.events.change)),(n.orig!==n.previouslySelected&&!n.keyHasChanged||n.orig!==r&&r)&&e.selectable.enabled||bt(e),en(e),e.draggable.current=void 0,e.dom.redraw()}function Jt(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,bt(e),en(e),e.dom.redraw())}function en(e){const t=e.dom.elements;t.ghost&&Ze(t.ghost,!1)}function tn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function nn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function rn(e,t){function n(){!function(e){e.orientation=He(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),Nt(e,t),(t.fen?Kt:Lt)((e=>_t(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,ze.map((e=>Ke.map((n=>{const r=t.get(n+e);if(r){let e=Rt[r.role];return"white"===r.color&&(e=e.toUpperCase()),r.promoted&&(e+="~"),e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){Kt((e=>function(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?Kt((e=>kt(e,t,n)),e):e.selected&&(bt(e),e.dom.redraw())},move(t,n){Kt((e=>dt(e,t,n)),e)},newPiece(t,n){Kt((e=>pt(e,t,n)),e)},playPremove(){if(e.premovable.current){if(Kt(St,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;t(n)&&pt(e,{role:n.role,color:e.movable.color},n.key)&&(ht(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0);return lt(e),r}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Lt(ut,e)},cancelPredrop(){Lt(lt,e)},cancelMove(){Lt((e=>{Et(e),Jt(e)}),e)},stop(){Lt((e=>{xt(e),Jt(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{nn(e,2),setTimeout((()=>nn(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Lt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Lt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>qt(t,Mt(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,r){!function(e,t,n,r){const s="a0";e.pieces.set(s,t),e.dom.redraw();const i=Xe(n);e.draggable.current={orig:s,piece:t,origPos:i,pos:i,started:!0,element:()=>tn(e,s),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},Yt(e)}(e,t,n,r)},destroy(){xt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function sn(e,t,n){const r=new Map,s=[];for(const t of e)r.set(t.hash,!1);let i,o=t.firstChild;for(;o;)i=o.getAttribute("cgHash"),r.has(i)?r.set(i,!0):s.push(o),o=o.nextSibling;for(const e of s)t.removeChild(e);for(const s of e)r.get(s.hash)||t.appendChild(n(s))}function on(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function an(e,t,n){const r=e.drawable,s=r.current,i=s&&s.mouseSq?s:void 0,o=new Map,a=e.dom.bounds(),c=r.autoShapes.filter((e=>!e.piece));for(const e of r.shapes.concat(c).concat(i?[i]:[]))e.dest&&o.set(e.dest,(o.get(e.dest)||0)+1);const h=r.shapes.concat(c).map((e=>({shape:e,current:!1,hash:cn(e,o,!1,a)})));i&&h.push({shape:i,current:!0,hash:cn(i,o,!0,a)});const u=h.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const l=t.querySelector("defs"),d=t.querySelector("g"),p=n.querySelector("g");!function(e,t,n){const r=new Map;let s;for(const n of t)n.shape.dest&&(s=e.brushes[n.shape.brush],n.shape.modifiers&&(s=mn(s,n.shape.modifiers)),r.set(s.key,s));const i=new Set;let o=n.firstChild;for(;o;)i.add(o.getAttribute("cgKey")),o=o.nextSibling;for(const[e,t]of r.entries())i.has(e)||n.appendChild(dn(t))}(r,h,l),sn(h.filter((e=>!e.shape.customSvg)),d,(t=>ln(e,t,r.brushes,o,a))),sn(h.filter((e=>e.shape.customSvg)),p,(t=>ln(e,t,r.brushes,o,a)))}function cn({orig:e,dest:t,brush:n,piece:r,modifiers:s,customSvg:i},o,a,c){return[c.width,c.height,a,e,t,n,t&&(o.get(t)||0)>1,r&&hn(r),s&&(h=s,""+(h.lineWidth||"")),i&&un(i)].filter((e=>e)).join(",");var h}function hn(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function un(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function ln(e,{shape:t,current:n,hash:r},s,i,o){let a;const c=fn(Fe(t.orig),e.orientation);if(t.customSvg)a=function(e,t,n){const[r,s]=vn(t,n),i=pn(on("g"),{transform:`translate(${r},${s})`}),o=pn(on("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(o),o.innerHTML=e,i}(t.customSvg,c,o);else if(t.dest){let r=s[t.brush];t.modifiers&&(r=mn(r,t.modifiers)),a=function(e,t,n,r,s,i){const o=function(e){return(e?20:10)/64}(s&&!r),a=vn(t,i),c=vn(n,i),h=c[0]-a[0],u=c[1]-a[1],l=Math.atan2(u,h),d=Math.cos(l)*o,p=Math.sin(l)*o;return pn(on("line"),{stroke:e.color,"stroke-width":gn(e,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:kn(e,r),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(r,c,fn(Fe(t.dest),e.orientation),n,(i.get(t.dest)||0)>1,o)}else a=function(e,t,n,r){const s=vn(t,r),i=[3/64,4/64],o=(r.width+r.height)/(4*Math.max(r.width,r.height));return pn(on("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:kn(e,n),cx:s[0],cy:s[1],r:o-i[1]/2})}(s[t.brush],c,n,o);return a.setAttribute("cgHash",r),a}function dn(e){const t=pn(on("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(pn(on("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function pn(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function fn(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function mn(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function gn(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function kn(e,t){return(e.opacity||1)*(t?.9:1)}function vn(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function bn(e,t){const n=et("coords",t);let r;for(const t of e)r=et("coord"),r.textContent=t,n.appendChild(r);return n}function wn(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),e.viewOnly)return;const r=function(e){return t=>{e.draggable.current?Jt(e):e.drawable.current?Wt(e):t.shiftKey||Je(t)?e.drawable.enabled&&$t(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;ut(e),lt(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=Xe(t),s=r&&qt(r,Mt(e),e.dom.bounds());s&&gt(e,"a0",s)}e.dom.redraw()}(e,t):Qt(e,t))}}(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function yn(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function Cn(e,t,n){return r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)}}function Sn(e){const t=Mt(e),n=Ge(e.dom.bounds()),r=e.dom.elements.board,s=e.pieces,i=e.animation.current,o=i?i.plan.anims:new Map,a=i?i.plan.fadings:new Map,c=e.draggable.current,h=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Rn(n,t,"last-move");e.check&&e.highlight.check&&Rn(n,e.check,"check");if(e.selected&&(Rn(n,e.selected,"selected"),e.movable.showDests)){const r=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(r)for(const t of r)Rn(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const s=e.premovable.dests;if(s)for(const t of s)Rn(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const r=e.premovable.current;if(r)for(const e of r)Rn(n,e,"current-premove");else e.predroppable.current&&Rn(n,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const e of s.keys)Rn(n,e,"exploding"+s.stage);return n}(e),u=new Set,l=new Set,d=new Map,p=new Map;let f,m,g,k,v,b,w,y,C,S;for(m=r.firstChild;m;){if(f=m.cgKey,xn(m))if(g=s.get(f),v=o.get(f),b=a.get(f),k=m.cgPiece,!m.cgDragging||c&&c.orig===f||(m.classList.remove("dragging"),Qe(m,n(Fe(f),t)),m.cgDragging=!1),!b&&m.cgFading&&(m.cgFading=!1,m.classList.remove("fading")),g){if(v&&m.cgAnimating&&k===An(g)){const e=Fe(f);e[0]+=v[2],e[1]+=v[3],m.classList.add("anim"),Qe(m,n(e,t))}else m.cgAnimating&&(m.cgAnimating=!1,m.classList.remove("anim"),Qe(m,n(Fe(f),t)),e.addPieceZIndex&&(m.style.zIndex=On(Fe(f),t)));k!==An(g)||b&&m.cgFading?b&&k===An(b)?(m.classList.add("fading"),m.cgFading=!0):Pn(d,k,m):u.add(f)}else Pn(d,k,m);else if(qn(m)){const e=m.className;h.get(f)===e?l.add(f):Pn(p,e,m)}m=m.nextSibling}for(const[e,s]of h)if(!l.has(e)){C=p.get(s),S=C&&C.pop();const i=n(Fe(e),t);if(S)S.cgKey=e,Qe(S,i);else{const t=et("square",s);t.cgKey=e,Qe(t,i),r.insertBefore(t,r.firstChild)}}for(const[i,a]of s)if(v=o.get(i),!u.has(i))if(w=d.get(An(a)),y=w&&w.pop(),y){y.cgKey=i,y.cgFading&&(y.classList.remove("fading"),y.cgFading=!1);const r=Fe(i);e.addPieceZIndex&&(y.style.zIndex=On(r,t)),v&&(y.cgAnimating=!0,y.classList.add("anim"),r[0]+=v[2],r[1]+=v[3]),Qe(y,n(r,t))}else{const s=An(a),o=et("piece",s),c=Fe(i);o.cgPiece=s,o.cgKey=i,v&&(o.cgAnimating=!0,c[0]+=v[2],c[1]+=v[3]),Qe(o,n(c,t)),e.addPieceZIndex&&(o.style.zIndex=On(c,t)),r.appendChild(o)}for(const t of d.values())Mn(e,t);for(const t of p.values())Mn(e,t)}function En(e){const t=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,r=t.height/t.width,s=8*Math.floor(t.width*window.devicePixelRatio/8)/window.devicePixelRatio,i=s*r;n.style.width=s+"px",n.style.height=i+"px",e.dom.bounds.clear(),e.addDimensionsCssVars&&(document.documentElement.style.setProperty("--cg-width",s+"px"),document.documentElement.style.setProperty("--cg-height",i+"px"))}function xn(e){return"PIECE"===e.tagName}function qn(e){return"SQUARE"===e.tagName}function Mn(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function On(e,t){const n=e[1];return`${t?10-n:3+n}`}function An(e){return`${e.color} ${e.role}`}function Rn(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function Pn(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function Nn(e,t){sn(e.drawable.autoShapes.filter((e=>e.piece)).map((e=>{return{shape:e,hash:(t=e,[t.orig,null===(n=t.piece)||void 0===n?void 0:n.role,null===(r=t.piece)||void 0===r?void 0:r.color,null===(s=t.piece)||void 0===s?void 0:s.scale].join(",")),current:!1};var t,n,r,s})),t,(t=>function(e,{shape:t,hash:n},r){var s,i,o;const a=t.orig,c=null===(s=t.piece)||void 0===s?void 0:s.role,h=null===(i=t.piece)||void 0===i?void 0:i.color,u=null===(o=t.piece)||void 0===o?void 0:o.scale,l=et("piece",`${c} ${h}`);return l.setAttribute("cgHash",n),l.cgKey=a,l.cgScale=u,Ye(l,Ge(r)(Fe(a),Mt(e)),u),l}(e,t,e.dom.bounds())))}function _n(e,t){const n={pieces:Pt(Ot),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,addDimensionsCssVars:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Ve()};function r(){const t="dom"in n?n.dom.unbind:void 0,r=function(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const n of Te)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const n=et("cg-container");e.appendChild(n);const r=et("cg-board");let s,i,o,a;if(n.appendChild(r),t.drawable.visible&&(s=pn(on("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(on("defs")),s.appendChild(on("g")),i=pn(on("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(on("g")),o=et("cg-auto-pieces"),n.appendChild(s),n.appendChild(i),n.appendChild(o)),t.coordinates){const e="black"===t.orientation?" black":"",r="left"===t.ranksPosition?" left":"";n.appendChild(bn(Le,"ranks"+e+r)),n.appendChild(bn(Ke,"files"+e))}return t.draggable.showGhost&&(a=et("piece","ghost"),Ze(a,!1),n.appendChild(a)),{board:r,container:n,wrap:e,ghost:a,svg:s,customSvg:i,autoPieces:o}}(e,n),s=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>r.board.getBoundingClientRect())),i=e=>{Sn(a),r.autoPieces&&Nn(a,r.autoPieces),!e&&r.svg&&an(a,r.svg,r.customSvg)},o=()=>{En(a),function(e){const t=Mt(e),n=Ge(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(xn(r)&&!r.cgAnimating||qn(r))&&Qe(r,n(Fe(r.cgKey),t)),r=r.nextSibling}(a),r.autoPieces&&function(e){var t;const n=Mt(e),r=Ge(e.dom.bounds());let s=null===(t=e.dom.elements.autoPieces)||void 0===t?void 0:t.firstChild;for(;s;)Ye(s,r(Fe(s.cgKey),n),s.cgScale),s=s.nextSibling}(a)},a=n;return a.dom={elements:r,bounds:s,redraw:Bn(i),redrawNow:i,unbind:t},a.drawable.prevSvgHash="",En(a),i(!1),wn(a,o),t||(a.dom.unbind=function(e,t){const n=[];if("ResizeObserver"in window||n.push(yn(document.body,"chessground.resize",t)),!e.viewOnly){const t=Cn(e,Zt,Vt),r=Cn(e,Xt,Ht);for(const e of["touchmove","mousemove"])n.push(yn(document,e,t));for(const e of["touchend","mouseup"])n.push(yn(document,e,r));const s=()=>e.dom.bounds.clear();n.push(yn(document,"scroll",s,{capture:!0,passive:!0})),n.push(yn(window,"resize",s,{passive:!0}))}return()=>n.forEach((e=>e()))}(a,o)),a.events.insert&&a.events.insert(r),a}return _t(n,t||{}),rn(r(),r)}function Bn(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function Tn(e){if(Kn(e)){for(;e&&Kn(e);){e=Ln(e).parent}return null!=e?e:null}return e.parentNode}function Kn(e){return 11===e.nodeType}function Ln(e,t){var n,r,s;const i=e;return null!==(n=i.parent)&&void 0!==n||(i.parent=null!=t?t:null),null!==(r=i.firstChildNode)&&void 0!==r||(i.firstChildNode=e.firstChild),null!==(s=i.lastChildNode)&&void 0!==s||(i.lastChildNode=e.lastChild),i}const zn={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createDocumentFragment:function(){return Ln(document.createDocumentFragment())},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){if(Kn(e)){let t=e;for(;t&&Kn(t);){t=Ln(t).parent}e=null!=t?t:e}Kn(t)&&(t=Ln(t,e)),n&&Kn(n)&&(n=Ln(n).firstChildNode),e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){Kn(t)&&(t=Ln(t,e)),e.appendChild(t)},parentNode:Tn,nextSibling:function(e){var t;if(Kn(e)){const n=Ln(e),r=Tn(n);if(r&&n.lastChildNode){const e=Array.from(r.childNodes),s=e.indexOf(n.lastChildNode);return null!==(t=e[s+1])&&void 0!==t?t:null}return null}return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType},isDocumentFragment:Kn};function Dn(e,t,n,r,s){return{sel:e,data:t,children:n,text:r,elm:s,key:void 0===t?void 0:t.key}}const In=Array.isArray;function Fn(e){return"string"==typeof e||"number"==typeof e||e instanceof String||e instanceof Number}function $n(e){return void 0===e}function Un(e){return void 0!==e}const Vn=Dn("",{},[],void 0,void 0);function Hn(e,t){var n,r;const s=e.key===t.key,i=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(r=t.data)||void 0===r?void 0:r.is),o=e.sel===t.sel,a=!(!e.sel&&e.sel===t.sel)||typeof e.text==typeof t.text;return o&&s&&i&&a}function Wn(){throw new Error("The document fragment is not supported on this platform.")}function jn(e,t,n){var r;const s={};for(let i=t;i<=n;++i){const t=null===(r=e[i])||void 0===r?void 0:r.key;void 0!==t&&(s[t]=i)}return s}const Gn=["create","update","remove","destroy","pre","post"];function Qn(e,t,n){const r={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},s=void 0!==t?t:zn;for(const t of Gn)for(const n of e){const e=n[t];void 0!==e&&r[t].push(e)}function i(e){const t=e.id?"#"+e.id:"",n=e.getAttribute("class"),r=n?"."+n.split(" ").join("."):"";return Dn(s.tagName(e).toLowerCase()+t+r,{},[],void 0,e)}function o(e){return Dn(void 0,{},[],void 0,e)}function a(e,t){return function(){if(0==--t){const t=s.parentNode(e);s.removeChild(t,e)}}}function c(e,t){var i,o,a,h;let u,l=e.data;if(void 0!==l){const t=null===(i=l.hook)||void 0===i?void 0:i.init;Un(t)&&(t(e),l=e.data)}const d=e.children,p=e.sel;if("!"===p)$n(e.text)&&(e.text=""),e.elm=s.createComment(e.text);else if(void 0!==p){const n=p.indexOf("#"),i=p.indexOf(".",n),a=n>0?n:p.length,h=i>0?i:p.length,f=-1!==n||-1!==i?p.slice(0,Math.min(a,h)):p,m=e.elm=Un(l)&&Un(u=l.ns)?s.createElementNS(u,f,l):s.createElement(f,l);for(a<h&&m.setAttribute("id",p.slice(a+1,h)),i>0&&m.setAttribute("class",p.slice(h+1).replace(/\./g," ")),u=0;u<r.create.length;++u)r.create[u](Vn,e);if(In(d))for(u=0;u<d.length;++u){const e=d[u];null!=e&&s.appendChild(m,c(e,t))}else Fn(e.text)&&s.appendChild(m,s.createTextNode(e.text));const g=e.data.hook;Un(g)&&(null===(o=g.create)||void 0===o||o.call(g,Vn,e),g.insert&&t.push(e))}else if((null===(a=null==n?void 0:n.experimental)||void 0===a?void 0:a.fragments)&&e.children){for(e.elm=(null!==(h=s.createDocumentFragment)&&void 0!==h?h:Wn)(),u=0;u<r.create.length;++u)r.create[u](Vn,e);for(u=0;u<e.children.length;++u){const n=e.children[u];null!=n&&s.appendChild(e.elm,c(n,t))}}else e.elm=s.createTextNode(e.text);return e.elm}function h(e,t,n,r,i,o){for(;r<=i;++r){const i=n[r];null!=i&&s.insertBefore(e,c(i,o),t)}}function u(e){var t,n;const s=e.data;if(void 0!==s){null===(n=null===(t=null==s?void 0:s.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<r.destroy.length;++t)r.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&u(n)}}}function l(e,t,n,i){for(var o,c;n<=i;++n){let i,h;const d=t[n];if(null!=d)if(Un(d.sel)){u(d),i=r.remove.length+1,h=a(d.elm,i);for(let e=0;e<r.remove.length;++e)r.remove[e](d,h);const e=null===(c=null===(o=null==d?void 0:d.data)||void 0===o?void 0:o.hook)||void 0===c?void 0:c.remove;Un(e)?e(d,h):h()}else d.children?(u(d),l(e,d.children,0,d.children.length-1)):s.removeChild(e,d.elm)}}function d(e,t,n){var i,o,a,u,p,f,m,g;const k=null===(i=t.data)||void 0===i?void 0:i.hook;null===(o=null==k?void 0:k.prepatch)||void 0===o||o.call(k,e,t);const v=t.elm=e.elm;if(e===t)return;if(void 0!==t.data||Un(t.text)&&t.text!==e.text){null!==(a=t.data)&&void 0!==a||(t.data={}),null!==(u=e.data)&&void 0!==u||(e.data={});for(let n=0;n<r.update.length;++n)r.update[n](e,t);null===(m=null===(f=null===(p=t.data)||void 0===p?void 0:p.hook)||void 0===f?void 0:f.update)||void 0===m||m.call(f,e,t)}const b=e.children,w=t.children;$n(t.text)?Un(b)&&Un(w)?b!==w&&function(e,t,n,r){let i,o,a,u,p=0,f=0,m=t.length-1,g=t[0],k=t[m],v=n.length-1,b=n[0],w=n[v];for(;p<=m&&f<=v;)null==g?g=t[++p]:null==k?k=t[--m]:null==b?b=n[++f]:null==w?w=n[--v]:Hn(g,b)?(d(g,b,r),g=t[++p],b=n[++f]):Hn(k,w)?(d(k,w,r),k=t[--m],w=n[--v]):Hn(g,w)?(d(g,w,r),s.insertBefore(e,g.elm,s.nextSibling(k.elm)),g=t[++p],w=n[--v]):Hn(k,b)?(d(k,b,r),s.insertBefore(e,k.elm,g.elm),k=t[--m],b=n[++f]):(void 0===i&&(i=jn(t,p,m)),o=i[b.key],$n(o)?s.insertBefore(e,c(b,r),g.elm):(a=t[o],a.sel!==b.sel?s.insertBefore(e,c(b,r),g.elm):(d(a,b,r),t[o]=void 0,s.insertBefore(e,a.elm,g.elm))),b=n[++f]);f<=v&&(u=null==n[v+1]?null:n[v+1].elm,h(e,u,n,f,v,r)),p<=m&&l(e,t,p,m)}(v,b,w,n):Un(w)?(Un(e.text)&&s.setTextContent(v,""),h(v,null,w,0,w.length-1,n)):Un(b)?l(v,b,0,b.length-1):Un(e.text)&&s.setTextContent(v,""):e.text!==t.text&&(Un(b)&&l(v,b,0,b.length-1),s.setTextContent(v,t.text)),null===(g=null==k?void 0:k.postpatch)||void 0===g||g.call(k,e,t)}return function(e,t){let n,a,h;const u=[];for(n=0;n<r.pre.length;++n)r.pre[n]();for(!function(e,t){return e.isElement(t)}(s,e)?function(e,t){return e.isDocumentFragment(t)}(s,e)&&(e=o(e)):e=i(e),Hn(e,t)?d(e,t,u):(a=e.elm,h=s.parentNode(a),c(t,u),null!==h&&(s.insertBefore(h,t.elm,s.nextSibling(a)),l(h,[e],0,0))),n=0;n<u.length;++n)u[n].data.hook.insert(u[n]);for(n=0;n<r.post.length;++n)r.post[n]();return t}}function Yn(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e];if("string"==typeof n)continue;const r=n.data;void 0!==r&&Yn(r,n.children,n.sel)}}function Zn(e,t,n){let r,s,i,o={};if(void 0!==n?(null!==t&&(o=t),In(n)?r=n:Fn(n)?s=n.toString():n&&n.sel&&(r=[n])):null!=t&&(In(t)?r=t:Fn(t)?s=t.toString():t&&t.sel?r=[t]:o=t),void 0!==r)for(i=0;i<r.length;++i)Fn(r[i])&&(r[i]=Dn(void 0,void 0,void 0,r[i],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||Yn(o,r,e),Dn(e,o,r,s,void 0)}function Xn(e,t){let n;const r=t.elm;let s=e.data.attrs,i=t.data.attrs;if((s||i)&&s!==i){for(n in s=s||{},i=i||{},i){const e=i[n];s[n]!==e&&(!0===e?r.setAttribute(n,""):!1===e?r.removeAttribute(n):120!==n.charCodeAt(0)?r.setAttribute(n,e):58===n.charCodeAt(3)?r.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?r.setAttributeNS("http://www.w3.org/1999/xlink",n,e):r.setAttribute(n,e))}for(n in s)n in i||r.removeAttribute(n)}}const Jn={create:Xn,update:Xn};function er(e,t){let n,r;const s=t.elm;let i=e.data.class,o=t.data.class;if((i||o)&&i!==o){for(r in i=i||{},o=o||{},i)i[r]&&!Object.prototype.hasOwnProperty.call(o,r)&&s.classList.remove(r);for(r in o)n=o[r],n!==i[r]&&s.classList[n?"add":"remove"](r)}}const tr={create:er,update:er};const nr=(e,t,n,r=!0)=>rr((s=>s.addEventListener(e,(e=>{const r=t(e);return!1===r&&e.preventDefault(),null==n||n(),r}),{passive:r})));function rr(e){return{insert:t=>e(t.elm)}}function sr(e){return e.menu?ir(e):Zn("div.lpv",[cr(e),or(e)])}const ir=e=>Zn("div.lpv.lpv--menu",[Zn("div.lpv__menu",Zn("div.lpv__menu__inner",[Zn("button.lpv__menu__entry.lp__menu__flip.fbt",{on:{click:e.flip}},"Flip the board"),Zn("a.lpv__menu__entry.lp__menu__analysis.fbt",{attrs:{href:e.analysisUrl(),target:"_blank"}},"Analysis board"),Zn("a.lpv__menu__entry.lp__menu__practice.fbt",{attrs:{href:e.practiceUrl(),target:"_blank"}},"Practice with computer")])),or(e)]),or=e=>Zn("div.lpv__controls",[ar("backward",e.index<1,e.backward),Zn("button.fbt.lpv__controls__menu",{class:{active:e.menu},on:{click:e.toggleMenu}},""),ar("forward",e.index>e.nodes.length-2,e.forward)]),ar=(e,t,n)=>Zn(`button.lpv__controls__${e}.fbt`,{class:{disabled:t},hook:rr((e=>function(e,t,n){for(const r of["touchstart","mousedown"])e.addEventListener(r,(e=>{t(e),e.preventDefault(),n&&n()}),{passive:!1})}(e,(e=>function(e,t){const n=()=>{e(),r=Math.max(100,r-r/15),s=setTimeout(n,r)};let r=350,s=setTimeout(n,500);e();const i="touchstart"==t.type?"touchend":"mouseup";document.addEventListener(i,(()=>clearTimeout(s)),{once:!0})}(n,e)))))}),cr=e=>Zn("div.lpv__board",{hook:hr(e)},Zn("div.cg-wrap",{hook:{insert:t=>e.ground=_n(t.elm,ur(e))}})),hr=e=>{return"ontouchstart"in window||!e.opts.scrollToMove?void 0:(t="wheel",n=function(e){let t=0;return n=>{t+=n.deltaY*(n.deltaMode?40:1),Math.abs(t)>=4?(e(n,!0),t=0):e(n,!1)}}(((t,n)=>{t.preventDefault(),t.deltaY>0&&n?e.forward():t.deltaY<0&&n&&e.backward()})),nr(t,n,r,!1));var t,n,r},ur=e=>Object.assign({viewOnly:!0,coordinates:!0,addDimensionsCssVars:!0,drawable:{enabled:!1,visible:!1}},e.cgOpts());return function(e,t){const n=Qn([tr,Jn]),r=new nt(t,(function(){i=n(i,sr(r))})),s=sr(r);e.innerHTML="";let i=n(e,s)}}();
